Global.Phrases={cache:{},load:async function(phrases){let self=Global.Phrases;let request=[];for(let phrase of typeof(phrases)=='string'?[phrases]:phrases){if(!(phrase in self.cache)){request.push(phrase);}}
if(request.length){response=await fetch(`/api/fetch/phrases/${request}`);response=await response.json();Object.assign(self.cache,response);}},get:function(key){let self=Global.Phrases;var msg=self.cache[key];if(!msg){console.log("phrase not loaded "+key);}
return msg||'';}}
var FavList={list:{},clear:()=>{let self=FavList;self.list={};},insert:(data)=>{let self=FavList;self.load();for(let item of data){if(!self.list[item.list_type]){self.list[item.list_type]=[];}
self.list[item.list_type].push(item.pub_id);}},get:(list_type)=>{let self=FavList;self.load();return self.list[list_type]||[];},save:()=>{let self=FavList;if(self.list)
window.localStorage.setItem('favList',JSON.stringify(self.list));},load:()=>{let self=FavList;try{self.list=JSON.parse(window.localStorage.getItem('favList')||'{}');}catch(error){self.list={};}
return self.list;},checked:(listName,pub_id)=>{let self=FavList;if(!self.list.length){self.load();}
return self.list[listName]&&self.list[listName].indexOf(pub_id)!=-1;},menuEvent:async(el,event)=>{event.stopPropagation();let self=FavList;var row=el.closest('.dropdown-item');await Global.Library.load(['ladda','axios']);Ladda.create(el).start();if(await self.sendEvent(el,'delete')){el.dataset.list_status=(el.dataset.list_status)*-1+1;}
Ladda.create(el).stop();row.classList.add('hide');setTimeout(function(){row.remove();},300)
for(let item of document.querySelectorAll(`.info-tag.info-favorite[data-pub_id='${el.dataset.pub_id}']`)){item.dataset.list_status="0"}},listingEvent:async(el)=>{let self=FavList;await Global.Library.load(['ladda','axios']);Ladda.create(el).start();if(await self.sendEvent(el)){el.dataset.list_status=(el.dataset.list_status)*-1+1;}
Ladda.create(el).stop();},listingOnChange:(base=document)=>{for(let item of base.querySelectorAll('.info-tag.info-favorite')){if(FavList.checked('favorite',item.dataset.pub_id)){item.dataset.list_status="1";}}},pubEvent:async(el)=>{let self=FavList;let list_type=el.dataset.list_type;if(el.dataset['require_login']=="1"&&!(Session.user_id>0)){Page.login();return;}
else{let total=el.querySelector('.list-total');let totalValue=0;if(total){totalValue=parseInt(total.innerHTML);}
await Global.Library.load(['ladda','axios']);Ladda.create(el).start();if(await self.sendEvent(el)){if(el.dataset.list_status==1){el.dataset.list_status=0;if(total&&totalValue>0){total.innerHTML=totalValue-1;}
if(list_type=='like'){document.getElementById('favDropdownIcon').classList.remove('font-weight-800');}}
else{el.dataset.list_status=1;if(total)
total.innerHTML=totalValue+1;if(list_type=='like'){document.getElementById('favDropdownIcon').classList.add('font-weight-800');}}}
Ladda.create(el).stop();}},sendEvent:async(el,action)=>{let self=FavList;try{let list_type=el.dataset.list_type;let pub_id=el.dataset.pub_id;let actionAdd=action?action=='post':el.dataset.list_status!=1;if(Session.user_id==pub_id){return false;}
self.load();if(actionAdd&&el.dataset.list_type=='favorite'){if(self.list.favorite){if(!(Session.user_id>0)&&self.list.favorite.length>=10){Alert.error(null,`<div class="px-10">Llegaste al límite de <label class='font-weight-800'>10 favoritos</label>! registrate para agregar más.</div>
                            <hr class="mt-10">
                            <button class='btn text-primary btn-xl w-full mb--20' onClick='Page.register();'>Registrarse</button>
                        `);return false;}
if(Session.user_id>0&&Session.user_type=='user'&&self.list.favorite.length>=20){Alert.error(null,"Llegaste al limite de 20 favoritos");return false;}}}
let request=axios({method:actionAdd?'post':'delete',url:`/api/favlist/${list_type}/${pub_id}`,data:{pub_id:pub_id,list_type:list_type,}});if(list_type=='favorite'&&actionAdd==true&&(!self.list[list_type]||self.list[list_type].length==0)){let[res]=await Promise.all([request,Global.Phrases.load(['FAVORITES_TUTORIAL_TITLE','FAVORITES_TUTORIAL_SUBTITLE']),]);}
else
{let res=await request;}
if(!self.list[list_type])
self.list[list_type]=[];var index=self.list[list_type].indexOf(pub_id);if(actionAdd){if(index==-1){self.list[list_type].push(pub_id);}}else{if(index>-1){self.list[list_type].splice(index,1);}}
if(list_type=='favorite'&&actionAdd==true&&self.list[list_type].length==1){Alert.success(null,`
                    <div class="text-center">
                        <h3 class="mt-10">${Global.Phrases.get('FAVORITES_TUTORIAL_TITLE')}</h3>
                        <div>${Global.Phrases.get('FAVORITES_TUTORIAL_SUBTITLE')}</div>
                        <video disableRemotePlayback loop muted playsinline autoplay class="mt-10 w-full" src="${Settings.url_static}/images/favorite-tutorial-1.mp4"></video>
                    </div>
                `);}
self.save();return true;}catch(err){console.log(err);Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
return false;},}
Page={load:async(libraries)=>{await Global.Library.load(libraries);},initialize:async()=>{},logout:()=>{FavList.clear();FavList.save();location.href='/logout';},loginProcess:(data)=>{FavList.clear();FavList.save();FavList.insert(data.favList);FavList.save();location.reload();},login:async()=>{let[$modal,response,countries]=await Promise.all([Modal.parse('login.tpl',{}),fetch(`${Settings.url_api}/auth/google`),Global.Library.load(['ladda','axios','now.form']),]);let data=await response.json();if(data.google_signin_link){$modal.find('a#google_signin_link').attr('href',data.google_signin_link);}
$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{let res=await axios.post(`${Settings.url_api}/auth/login`,form.serialize());Page.loginProcess(res.data);}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});Modal.render($modal);},register:async()=>{if(Session.user_id>0){await Global.Phrases.load(['ALERT_ALREADY_REGISTERED']);Alert.error("ALERT_ALREADY_REGISTERED");return;}
let[$modal,response]=await Promise.all([Modal.parse('register-step1.tpl',{}),fetch(`${Settings.url_api}/auth/google`),Global.Library.load(['ladda','axios','now.form']),]);let data=await response.json();if(data.google_signin_link){$modal.find('a#google_signin_link').attr('href',data.google_signin_link);}
Modal.render($modal,{stack:false});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{let res=await axios.post(`${Settings.url_api}/auth/check/email`,form.serialize());Modal.hide();Page.registerForm();}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});},registerForm:async()=>{let[$modal,response]=await Promise.all([Modal.parse('register-step2.tpl',{}),fetch(`${Settings.url_api}/regions`),Global.Phrases.load(['ALERT_USER_REGISTER_SUCCESS']),Global.Library.load(['intlTelInput','select2','ladda','axios','now.form','now.collection','select2region','throttle']),]);await Modal.render($modal,{stack:false});let regionData=await response.json();Global.Region=new Global.Collection('id',regionData);$modal.find('select[name="pub_region"]').select2region();$modal.find('.radio-option').on('click',function(e){e.preventDefault();var target=$(this).attr('data-target');var nm=$(this).attr('data-namespace');$modal.find(nm).removeClass('show');$modal.find(target).addClass('show');$modal.find('.radio-option').removeClass('selected');$(this).addClass('selected');});if($modal.find('.radio-option').length==1){$modal.find('.radio-option').trigger('click');}
$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{if(form.get('user_type')=='user'){form.set('favorite',FavList.get('favorite'));}
else if(form.get('user_type')=='girl')
{var phone=window.intlTelInputGlobals.getInstance($modal.find('[name="pub_whatsapp"]')[0]);form.set('pub_whatsapp',phone.getNumber());}
else
{throw 'user type unknown';}
let response=await axios.post(`${Settings.url_api}${$(this).attr('data-target')}`,form.serialize());if(form.get('user_type')=='girl'){Page.registerComplete(response.data);}
else
{await Alert.success('ALERT_USER_REGISTER_SUCCESS');window.location.href="/";}
Modal.hide();}catch(err){Alert.confirm({'title':'Oops','msg':err.response?err.response.data.message:err,'type':'OK',});}
form.unlock();});},registerComplete:async(data)=>{let[$modal,response]=await Promise.all([Modal.parse('register-step3.tpl',{},false),Global.Phrases.load(['ALERT_GIRL_REGISTER_SUCCESS']),Global.Library.load(['ladda','axios','dropzone','now.form']),]);await Modal.render($modal,{stack:false});Page.loadPlugins($modal);$modal.find('#drop-container').dropzone({url:`${Settings.url_api}/profile/avatar`,method:"post",timeout:300000,maxFilesize:20,createImageThumbnails:false,acceptedFiles:'image/*',success:function(response){response=JSON.parse(response.xhr.response);$modal.find('#drop-container').html(`<img src="/upload/${response.pub_id}/avatar.jpg?${response.avatar_uploaded||'0'}" class="object-fit events-none"/>`);},});$modal.find('.register-gallery').on('click','[role="deleteGallery"]',async function(){let $img=$(this).closest('.register-gallery-item');axios.delete(`/api/profile/media/${$(this).data('media_id')}`).then(function(res){$img.remove();});});$modal.find('[role="uploadGallery"]').dropzone({url:`${Settings.url_api}/profile/media`,method:"post",timeout:300000,maxFilesize:99,acceptedFiles:'image/*',createImageThumbnails:false,success:function(response){response=JSON.parse(response.xhr.response);$modal.find('[role="uploadGallery"]').after(`
                    <div class="register-gallery-item flex-shrink-0 position-relative">
                        <img src="/upload/${response.pub_id}/${response.media_id}/${response.media_link}/270w.jpg" class="object-fit"/>
                        <i class="btn btn-default btn-circle fa fa-times absolute-center" role="deleteGallery" data-media_id="${response.media_id}"></i>
                    </div>`);},});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{await axios.post(`${Settings.url_api}/profile/pub`,form.serialize());Modal.hide();if(data.whatsappRegisterValidation=="1"){Page.validateWhatAppStep1(data);}
else{Page.registerSuccess();}}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});},validateWhatAppStep1:async(data={})=>{let[$modal,response]=await Promise.all([Modal.parse('whatsapp-validation-1.tpl',data),Global.Library.load(['ladda','axios','now.form']),]);Modal.render($modal,{stack:false});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{var phone=window.intlTelInputGlobals.getInstance($modal.find('[name="pub_whatsapp"]')[0]);form.set('pub_whatsapp',phone.getNumber());await axios.post(`${Settings.url_api}/profile/whatsapp`,form.serialize());Modal.hide();return Page.validateWhatAppStep2(form.getAll(),data);}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});return;},validateWhatAppStep2:async(data,params={})=>{let[$modal,response]=await Promise.all([Modal.parse('whatsapp-validation-2.tpl',data),Global.Phrases.load(['ALERT_GIRL_REGISTER_SUCCESS']),Global.Library.load(['ladda','axios','now.form']),]);Modal.render($modal,{stack:false});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{let response=await axios.post(`${Settings.url_api}/profile/whatsapp/code`,form.serialize());$('input[name="pub_whatsapp"]').val(response.data.pub_whatsapp);Modal.hide();if(params.whatsappRegisterValidation){Page.registerSuccess();}}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});},registerSuccess:async()=>{await Alert.success('ALERT_GIRL_REGISTER_SUCCESS');window.location.href="/account";},registerGoogleFail:()=>{Alert.confirm({'title':'Oops','msg':'El email esta en uso','type':'OK',});},recoveryInit:async()=>{let[$modal,response]=await Promise.all([Modal.parse('recovery-init.tpl'),Global.Library.load(['ladda','axios','now.form']),]);Modal.render($modal,{stack:false});$modal.find('button[role="byEmail"]').on('click',async function(e){Modal.hide();return Page.recoveryStep1({method:'email',});});$modal.find('button[role="byWhatsapp"]').on('click',async function(e){Modal.hide();return Page.recoveryStep1({method:'whatsapp',});});},recoveryStep1:async(params)=>{let[$modal,response]=await Promise.all([Modal.parse(`recovery-step-1-${params.method}.tpl`),Global.Library.load(['ladda','axios','now.form']),]);Modal.render($modal,{stack:false});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{if(params.method=='whatsapp'){var phone=window.intlTelInputGlobals.getInstance($modal.find('[name="pub_whatsapp"]')[0]);if(phone)
form.set('pub_whatsapp',phone.getNumber())};let response=await axios.post(`${Settings.url_api}/auth/recovery/${params.method}`,form.serialize());Modal.hide();return Page.recoveryStep2(form.getAll(),params);}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});return;},recoveryStep2:async(data,params={})=>{let[$modal,response]=await Promise.all([Modal.parse(`recovery-step-2-${params.method}.tpl`,data),]);Modal.render($modal,{stack:false});$modal.find('form').on('submit',async function(e){e.preventDefault();let form=new Global.Form(e.target);if(form.lock())return false;try{let response=await axios.post(`${Settings.url_api}/auth/recovery/code`,form.serialize());Page.loginProcess(response.data);}catch(err){Alert.confirm({'title':'Oops','msg':err.response.data.message||err,'type':'OK',});}
form.unlock();});},sendEvent:(el)=>{fetch("/api/stats/event",{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(el.dataset)});},sendWhatsapp:(type,phone,text='')=>{let link=`https://wa.me/${(phone?phone:Global.Whatsapp.phone.admin).replace(new RegExp(/[\\\s-+]/,'g'),'')}?text=${Global.Whatsapp[type]?Global.Whatsapp[type]:text}`;window.open(link);},sendFeedback:async(type)=>{let[$modal]=await Promise.all([Modal.load('feedback',{}),Global.Library.load(['ladda','axios','dropzone','now.form']),]);Modal.render($modal,{stack:false});},loadPlugins:async(base)=>{Page.horizontalScroll(base);Page.loadSelect2(base);Page.loadSelectPicker(base);Page.loadSwitchery(base);Page.loadintlTelInput(base);Page.loadAnalytics(base);},loadAnalytics:async(base)=>{let elements=base.find('a[data-track]');if(elements.length){$(elements).on('click',function(e){Page.sendEvent(this)});}},horizontalScroll:async(base)=>{let elements=base.find('.horizontal-scroll');if(elements.length){if(!Global.Utils.isMobile()){await Global.Library.load(['throttle','scrollbooster']);for(let el of elements){let viewport=$(el).parent();viewport.css('overflow','hidden');let sb=new ScrollBooster({viewport:viewport[0],content:el,direction:"horizontal",emulateScroll:false,scrollMode:"native",onClick:(state,event)=>{if(state.isMoving==true){event.preventDefault();event.stopPropagation();return;}},});let tab=$(el).closest('.tab-pane');if(tab.length){let col=tab.attr('data-col');tab.closest('.nav-tabs').find(`.nav-link[data-col="${col}"]`).on('click',async function(){await new Promise(r=>setTimeout(r,50));sb.updateMetrics();});}
$(el).parent().on('scroll',$.throttle(250,function(){if($(this).scrollLeft()>25){$(this).closest('.relative').children('.horizontal-scroll-more').addClass('opacity-hide');}else{$(this).closest('.relative').children('.horizontal-scroll-more').removeClass('opacity-hide');}}));}}
else{await Global.Library.load(['throttle']);for(let el of elements){$(el).on('scroll',$.throttle(250,function(){if($(this).scrollLeft()>25){$(this).closest('.relative').children('.horizontal-scroll-more').addClass('opacity-hide');}else{$(this).closest('.relative').children('.horizontal-scroll-more').removeClass('opacity-hide');}}));}}}},loadintlTelInput:async(base)=>{let elements=base.find('input[data-plugin="intlTelInput"]');if(elements.length){await Global.Library.load(['intlTelInput']);for(let elem of elements){intlTelInput(elem,{preferredCountries:['ar','br','cl','co','ec','es','mx','pe','py','uy','vz'],nationalMode:elem.dataset.national_mode==true?true:false,autoPlaceholder:"aggressive",initialCountry:Settings.user_country,utilsScript:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.5/js/utils.min.js"});}}},loadSwitchery:async(base)=>{let elements=base.find('input[data-plugin="switchery"]');if(elements.length){await Global.Library.load(['switchery']);for(let elem of elements){var size=$(elem).data('size');var init=new Switchery(elem,{size:size?size:'default',});}}},loadClipboard:async(base)=>{let elements=base.find('button[data-plugin="clipboard"]');if(elements.length){for(let link of elements){link.addEventListener('click',function(e){e.preventDefault();const el=document.createElement('textarea');el.value=link.dataset['clipboardtext'];el.setAttribute('readonly','');el.style.position='absolute';el.style.left='-9999px';document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);});}}},loadSelect2:async(base)=>{let elements=base.find('select[data-plugin="select2"],button[data-plugin="select2"]');if(elements.length){await Global.Library.load(['select2']);for(let select of elements){let $select=$(select);var s2instance=$select.select2({placeholder:"Seleccionar",escapeMarkup:function(text){return text;},allowClear:true,closeOnSelect:!$select.attr('multiple'),sorter:function(data){return data.sort(function(a,b){return a.text<b.text?-1:a.text>b.text?1:0;});}});let value=$select.attr('value');if(value){if($select.attr('multiple')){s2instance.val(Global.Utils.split(value))}
else{s2instance.val(value);}
s2instance.trigger('change.select2');}}}},loadSelectPicker:async(base)=>{var elements=base.find('select[data-plugin="selectpicker"]');if(elements.length){await Global.Library.load(['selectpicker']);for(let select of elements){let $select=$(select);$select.selectpicker({style:'',});let value=$select.attr('value');if(value){if($select.attr('multiple')){$select.selectpicker('val',Global.Utils.split(value));}
else{$select.selectpicker('val',value);}
$select.selectpicker('refresh');}}}}}