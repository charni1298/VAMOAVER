(function($){$.fn.story=function(config){var storyData=[];var root=null;var modal=null;var current_story=null;var template=Twig.twig({data:document.getElementById('story-modal.tpl').innerHTML});let open=async(index=0)=>{await Global.Library.load(['moment']);$('body').addClass('no-overflow ');storyData=[];for(e of root.children()){let tmp=$(e).data();storyData.push(tmp);}
modal=$(template.render({'storyList':storyData,session:Session}));modal.on("animationend",function(e){let story=$(e.target).closest('.story');next(story);}).on('click','.story-prev',function(){prev($(this).closest('.story'));}).on('click','.story-next',function(){next($(this).closest('.story'));}).on("click",'.story-unmute',function(e){let story=$(e.target).closest('.story');unmuteVideo(story);}).on("click",'[role="close"]',function(e){close();}).on('click','[role="deleteStory"]',function(e){del(e.target.closest('.story'));});$('body').append(modal);showStory(index);};let del=async(story)=>{let self=this;try{let pub_id=story.dataset.pub_id;let story_id=current_item[0].dataset.id;await fetch(`/api/profile/story/${story_id}`,{method:'DELETE'});close();location.reload();}catch(error){}};let renderTimeline=function(target){let self=this;options.seen=getLocalData();tplTimeline=$(timeline(options));tplTimeline.on('click','.story',function(e){e.preventDefault();e.stopPropagation();let index=$(this).index();open(index);});$(target).html(tplTimeline);};let close=()=>{$('body').removeClass('no-overflow ');modal.remove();current_story=null;current_item=null;};let off=(story)=>{let index=story.data('show');let media=$(story.find('.story-content').children().get(index));if(media.is('video')){media[0].pause();media[0].currentTime=0;}}
let unmuteVideo=(story)=>{let index=story.data('show');let media=$(story.find('.story-content').children().get(index));if(media.is('video')){let video=media[0];video.muted=false;video.volume=1.0;video.removeAttribute('muted');story.find('.story-unmute').hide();}}
let showStory=(index=0,last=false)=>{console.log(index);let story=$(modal.find('.story').get(index));current_story=story;story.find('.story-content').children().removeClass('show');modal.find('.story-scroll').css('transform','translate3d(-'+(100*index)+'vw,0px,0px)');let item_index=last?story.find('.story-content').children().length-1:0;showItem(story,item_index);};let showItem=(story,item_index=0)=>{story.data('show',item_index);modal.find('.story-progress').find('div').removeClass('active');let slide=$(story.find('.story-progress').find('div').get(item_index));story.find('.story-content').children().removeClass('show');let media=$(story.find('.story-content').children().get(item_index));current_item=media;story.find('.ago').html(moment(media.data('ago')+"Z").local().fromNow());slide.prevAll().addClass('done');slide.removeClass('done');slide.nextAll().removeClass('done');if(media.is('video')){let video=media[0];slide.addClass('paused');if(video.hasAttribute("controls")){video.removeAttribute("controls")}
if(!Global.Utils.isMobile()){video.muted=false;video.volume=1.0;video.removeAttribute('muted');story.find('.story-unmute').hide();}
else{if(video.hasAttribute('muted')){story.find('.story-unmute').show();}else{story.find('.story-unmute').hide();}}
var setDuration=function setDuration(){if(video.duration){slide.find('b').css('animation-duration',`${video.duration}s`);slide.addClass('active');}};setDuration();video.addEventListener("loadedmetadata",setDuration);video.onwaiting=function(){slide.addClass('paused');}
video.onplaying=function(){slide.removeClass('paused');}
video.currentTime=0;video.play();}else{story.find('.story-unmute').hide();slide.find('b').css('animation-duration',`5s`);slide.addClass('paused');slide.addClass('active');setTimeout(function(){slide.removeClass('paused');},300);}
media.addClass('show');};let next=(story)=>{off(story);let pos_story=story.index();let pos_item=story.data('show');if(pos_item<getTotalItems(story)-1){showItem(story,pos_item+1);return;}
seenStory(story)
if(pos_story<getTotalStories()-1){showStory(pos_story+1);return;}
close();};let prev=(story)=>{let pos_story=story.index();let pos_item=story.data('show');if(pos_item>0){off(story);showItem(story,pos_item-1);return;}
if(pos_story>0){off(story);showStory(pos_story-1,true);return;}};let getTotalStories=(index)=>{return modal.find('.story').length;}
let getTotalItems=(story)=>{return $(story).find('.story-content').children().length;}
let add=(data)=>{this.options.stories[0].media.push(data);};let getLocalData=()=>{var keyName='stories_seen';return window.localStorage[keyName]?JSON.parse(window.localStorage[keyName]):{};};let seenStory=(story)=>{let story_id=story.data('story_id');let media_id=story.data('media_id');$('.stories-list').find(`[data-story_id="${story_id}"] .img`).addClass('seen');let seen=getLocalData();seen[story_id]=media_id;var keyName='stories_seen';window.localStorage[keyName]=JSON.stringify(seen);};let localData=getLocalData();this.each(function(){$(this).find('.story');$(this).on('click','.listing-story',function(e){root=$(this).closest('.section-listing');e.preventDefault();e.stopPropagation();open($(this).closest('.story').index());});});return this;};}(jQuery));